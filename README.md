# k8s-coredump-detector

----

 K8s-coredump-detector is an open source tool for managing core dump feature in kubernetes.
 It enables stable, controllable core dump feature when jobs inside k8s containers were crashed.
 This feature mainly generate, store, distribute core files which generated by the apps inside pods,
 it could ease investigation of crashed application in multi-tenancy k8s environment. And tenant
 could download this core files like they are using any other original k8s functions.

----

## Motivation and Goals

As we know, bugs are inevitable in software development, some bugs could be solved by investigating app logs, but some serious bugs like deep null point exception is very hard to debug without core files.However, Kubernetes has no mechanism to manage core files when job inside pods crashed.

This feature mainly collects, stores, distributes core files which generated by the apps inside pods. It supports any filesystem storage as backend storage, and it embeds the K8s' own authorization mechanism like RBAC to control tenant authorities. Tenants could download those core files they want like they are using any other original K8s resources. 

## Design

### Backend storage

The bakcend storage is an independent filesystem storage to store core files. This storage could be either ceph filesystem storage,
nfs storage or any other filesystem storage.
For test purpose, you can also use local host[https://kubernetes.io/docs/concepts/storage/volumes/#hostpath] storage to store core files.

### Core file generation

<img src="https://github.com/WanLinghao/coredump-detector/blob/master/pictures/design_coredump.jpg" width="500">

The core file generation part generates core files when job inside containers crashed. In each node that supports core dump feature,
 a admin-pod will be deployed by DaemonSet to handle this job. Each admin-pod inject an executable file  called handler into node,
 it also modifies[core-pattern] to let kernel call that handler to store core files into backend storage.

### Downloding core files

<img src="https://github.com/WanLinghao/coredump-detector/blob/master/pictures/design_user.jpg" width="500">

An aggregation api layer will register a self-defined API called `coredump.fujitsu.com`. This api is a bridge between backend storage
 and users. User could download core files by this api. Admin can control users' access to core files by native way like RBAC, ABAC.

### Warning

The `core_pattern` would be modified to let our components handle core dump events.

The k8s cluster must boot with `allow-privileged` option enabled.

## Deployment

### From script

We have a [auto deploy script](deploy/deploy.sh) which could generate a yaml file. Then run `kubectl create -f [yaml file]` deploy it in your cluster.
This script uses local '/tmp' directory as backend storage to store core files and etcd data.
It also generates certificates automatically to let [aggregation api](https://kubernetes.io/docs/tasks/access-kubernetes-api/setup-extension-api-server/) use.
You could replace either backend storage or certificates with your own one.

### From source code

TBD

### Test

After deploying all the components successfully, you could test the function is working by [test script](test/run-test.sh)


## Download core files

### From exist pod
Suppose users want to download core files from a container called `test-container` in exist pod `default/test-pod`, they should do like:

```
cat test/coredumpendpoint_template.yaml |sed "s/__NAMESPACE__/default/g" | sed "s/__NAME__/test-pod/g"| kubectl create -f -
kubectl get --raw=/apis/coredump.fujitsu.com/v1alpha1/namespaces/default/coredumpendpoints/test-pod/dump?container=test-container>>coredump.tar.gz
```

### From non-exist pod
When users want to download core files from a pod that has been deleted, pod's uid must be provided.
Suppose users want to download core files from a container called `test-container` in exist pod `default/test-pod`, and the uid of that pod  is `1234-5678`, they should do like:

```
cat test/coredumpendpoint_template.yaml |sed "s/__NAMESPACE__/default/g" | sed "s/__NAME__/test-pod/g"| sed "s/__UID__/1234-5678/g"|kubectl create -f -
kubectl get --raw=/apis/coredump.fujitsu.com/v1alpha1/namespaces/default/coredumpendpoints/test-pod/dump?container=test-container>>coredump.tar.gz
```
